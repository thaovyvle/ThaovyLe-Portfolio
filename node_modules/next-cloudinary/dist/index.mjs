import Oe,{useState as Ue,useCallback as Ee,forwardRef as Pe}from"react";import we from"next/image";import{getTransformations as _e}from"@cloudinary-util/util";import{transformationPlugins as xe}from"@cloudinary-util/url-loader";import Ie from"next/package.json";var K={name:"next-cloudinary",version:"6.6.2",license:"MIT",main:"./dist/index.js",module:"./dist/index.mjs",types:"./dist/index.d.ts",source:"src/index.ts",scripts:{build:"tsup",dev:"tsup --watch",prepublishOnly:"cp ../README.md . && cp ../LICENSE . && pnpm build",postpublish:"rm ./README.md && rm ./LICENSE",test:"vitest run","test:app":'NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME="test" pnpm build && cd tests/nextjs-app && npm install && npm run build',"test:watch":"vitest"},dependencies:{"@cloudinary-util/types":"1.0.5","@cloudinary-util/url-loader":"5.3.1","@cloudinary-util/util":"^3.0.0","@tsconfig/recommended":"^1.0.3"},devDependencies:{"@babel/core":"^7.23.2","@babel/preset-env":"^7.23.2","@types/node":"^20.11.5","@types/react":"^18.2.33","@types/react-dom":"^18.2.14",dotenv:"^16.3.1",mkdirp:"^3.0.1",tsup:"^7.2.0",typescript:"^5.2.2",vitest:"^1.3.1"},peerDependencies:{next:"^12 || ^13 || ^14",react:"^17 || ^18"}};var Q="A",J="V",Z=te(Ie.version),ee=te(K.version);function te(e){let t=e;return t.includes("-")&&(t=t.split("-")[0]),t}async function S(e){let{src:t}=e;try{await new Promise((d,i)=>{fetch(t).then(o=>{if(!o.ok){i(o);return}d(o)})})}catch(d){return d.status===423?(await new Promise(i=>setTimeout(()=>i(void 0),200)),await S(e)):!1}return!0}function x(e){let t=e?.cloud?.cloudName??process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME;if(!t)throw new Error("A Cloudinary Cloud name is required, please make sure NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME is set and configured in your environment.");let d=e?.cloud?.apiKey??process.env.NEXT_PUBLIC_CLOUDINARY_API_KEY,i=e?.url?.secureDistribution??process.env.NEXT_PUBLIC_CLOUDINARY_SECURE_DISTRIBUTION,o=e?.url?.privateCdn??process.env.NEXT_PUBLIC_CLOUDINARY_PRIVATE_CDN;return Object.assign({cloud:{...e?.cloud,apiKey:d,cloudName:t},url:{...e?.url,secureDistribution:i,privateCdn:o}},e)}function V(e){return Object.assign({product:Q,sdkCode:J,sdkSemver:ee,techVersion:Z,feature:""},e)}import{constructCloudinaryUrl as he}from"@cloudinary-util/url-loader";function v(e,t,d){return he({options:e,config:x(t),analytics:V(d)})}function B({loaderOptions:e,imageProps:t,cldOptions:d,cldConfig:i={}}){let o={...t,...d};if(o.width=typeof o.width=="string"?parseInt(o.width):o.width,o.height=typeof o.height=="string"?parseInt(o.height):o.height,typeof e?.width=="number"&&typeof o.width=="number"&&e.width!==o.width){let n=e.width/o.width;o.width=e.width,typeof o.height=="number"&&(o.height=Math.floor(o.height*n))}else typeof e?.width=="number"&&typeof o?.width!="number"&&(o.width=e?.width);return v(o,i)}var Te=Pe(function(t,d){let i=!1,o=["assetType","config","deliveryType","preserveTransformations","strictTransformations"];xe.forEach(({props:r})=>{Object.keys(r).forEach(f=>{if(o.includes(f))throw new Error(`Option ${f} already exists!`);o.push(f)})});let n={alt:t.alt,src:t.src};Object.keys(t).filter(r=>typeof r=="string"&&!o.includes(r)).forEach(r=>n[r]=t[r]);let l=Object.keys(n).map(r=>`${r}:${n[r]}`).join(";"),[C,I]=Ue(l),a={};if(o.forEach(r=>{let c=t[r];c&&(a[r]=c||void 0)}),t.preserveTransformations)try{let r=_e(t.src).map(c=>c.join(","));a.rawTransformations=[...r.flat(),...t.rawTransformations||[]]}catch(r){console.warn(`Failed to preserve transformations: ${r.message}`)}let s=process.env.__NEXT_IMAGE_OPTS||{};(t.unoptimized===!0||s?.unoptimized===!0)&&(n.src=v({...a,width:n.width,height:n.height,src:n.src,format:"default",quality:"default"},t.config));async function E(r){let c=!0;if(i)return;if(i=!0,typeof t.onError=="function"){let w=t.onError(r);typeof w=="boolean"&&w===!1&&(c=!1)}else typeof t.onError=="boolean"&&t.onError===!1&&(c=!1);if(c===!1)return;let f=r.target;await S({src:f.src})&&I(`${l};${Date.now()}`)}let T=Ee(E,[S,l]),m=we;return"default"in m&&(m=m.default),Oe.createElement(m,{key:C,...n,loader:r=>B({loaderOptions:r,imageProps:n,cldOptions:a,cldConfig:t.config}),onError:T,ref:d})}),oe=Te;import U from"react";import Ae from"next/head";function k(e){return v({...e,format:e.format||"jpg",width:e.width||1200,height:e.height||627,crop:e.crop||{type:"fill",gravity:"center",source:!0}})}var Le="summary_large_image",ve=({excludeTags:e=[],twitterTitle:t,keys:d={},...i})=>{let{alt:o}=i,{width:n=1200,height:l=627}=i;n=typeof n=="string"?parseInt(n):n,l=typeof l=="string"?parseInt(l):l;let C=k({...i,width:n,height:l}),I=k({...i,width:n,height:l,format:i.format||"webp"}),a={"og:image":"og-image","og:image:secure_url":"og-image-secureurl","og:image:width":"og-image-width","og:image:height":"og-image-height","og:image:alt":"og-image-alt","twitter:title":"twitter-title","twitter:card":"twitter-card","twitter:image":"twitter-image",...d};return U.createElement(Ae,null,U.createElement("meta",{key:a["og:image"],property:"og:image",content:C}),U.createElement("meta",{key:a["og:image:secure_url"],property:"og:image:secure_url",content:C}),U.createElement("meta",{key:a["og:image:width"],property:"og:image:width",content:`${n}`}),U.createElement("meta",{key:a["og:image:height"],property:"og:image:height",content:`${l}`}),o&&U.createElement("meta",{key:a["og:image:alt"],property:"og:image:alt",content:o}),!e.includes("twitter:title")&&U.createElement("meta",{key:a["twitter:title"],property:"twitter:title",content:t||" "}),U.createElement("meta",{key:a["twitter:card"],property:"twitter:card",content:Le}),U.createElement("meta",{key:a["twitter:image"],property:"twitter:image",content:I}))},re=ve;import R from"react";import X,{useState as F,useEffect as ie,useRef as de}from"react";import be from"next/script";function ne(e){return window&&"requestIdleCallback"in window?requestIdleCallback(e):setTimeout(()=>e(),1)}var Ne=["success"],Me={abort:"onAbort","batch-cancelled":"onBatchCancelled",close:"onClose","display-changed":"onDisplayChanged",publicid:"onPublicId","queues-end":"onQueuesEnd","queues-start":"onQueuesStart",retry:"onRetry","show-completed":"onShowCompleted","source-changed":"onSourceChanged",success:"onSuccess",tags:"onTags","upload-added":"onUploadAdded"},We=({children:e,config:t,onError:d,onOpen:i,onUpload:o,options:n,signatureEndpoint:l,uploadPreset:C,...I})=>{let a=de(),s=de(),E=!!l,[T,m]=F(void 0),[r,c]=F(void 0),[f,P]=F(!0),w=x(t),{cloudName:_,apiKey:h}=w?.cloud,O={cloudName:_,uploadPreset:C||process.env.NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET,apiKey:h,...n};E&&(O.uploadSignature=A,O.apiKey||console.warn("Missing dependency: Signed Upload requires an API key")),ie(()=>{if(typeof r>"u")return;r.event==="success"&&typeof o=="function"&&(process.env.NODE_ENVIRONMENT==="development"&&console.warn("The onUpload callback is deprecated. Please use onSuccess instead."),o(r,s.current))},[r]);function W(){P(!1),a.current||(a.current=window.cloudinary),ne(()=>{s.current||(s.current=z())})}ie(()=>()=>{s.current?.destroy(),s.current=void 0},[]);function A(p,y){if(typeof l>"u")throw Error("Failed to generate signature: signatureEndpoint undefined.");fetch(l,{method:"POST",body:JSON.stringify({paramsToSign:y}),headers:{"Content-Type":"application/json"}}).then(L=>L.json()).then(({signature:L})=>{p(L)})}function u(p,y=[]){if(s.current||(s.current=z()),typeof s?.current[p]=="function")return s.current[p](...y)}function M(p){u("close",[p])}function N(p){return u("destroy",[p])}function g(){u("hide")}function D(){return u("isDestroyed")}function pe(){return u("isMinimized")}function ce(){return u("isShowing")}function ue(){u("minimize")}function ge(p,y){u("open",[p,y]),typeof i=="function"&&i(s.current)}function me(){u("show")}function fe(){u("update")}let $={close:M,destroy:N,hide:g,isDestroyed:D,isMinimized:pe,isShowing:ce,minimize:ue,open:ge,show:me,update:fe};function z(){return a.current?.createUploadWidget(O,(p,y)=>{if(p&&p!==null&&(m(p),typeof d=="function"&&d(p,{widget:s.current,...$})),typeof y?.event=="string"){Ne.includes(y?.event)&&c(y);let L=Me[y.event];if(typeof L=="string"&&typeof I[L]=="function"){let ye=I[L];ye(y,{widget:s.current,...$})}}})}return X.createElement(X.Fragment,null,typeof e=="function"&&e({cloudinary:a.current,widget:s.current,results:r,error:T,isLoading:f,...$}),X.createElement(be,{id:`cloudinary-uploadwidget-${Math.floor(Math.random()*100)}`,src:"https://upload-widget.cloudinary.com/global/all.js",onLoad:W,onError:p=>console.error(`Failed to load Cloudinary Upload Widget: ${p.message}`)}))},G=We;var De=({className:e,children:t,onClick:d,onError:i,onOpen:o,onUpload:n,onAbort:l,onBatchCancelled:C,onClose:I,onDisplayChanged:a,onPublicId:s,onQueuesEnd:E,onQueuesStart:T,onRetry:m,onShowCompleted:r,onSourceChanged:c,onSuccess:f,onTags:P,onUploadAdded:w,options:_,signatureEndpoint:h,uploadPreset:O,...W})=>R.createElement(R.Fragment,null,R.createElement(G,{onError:i,onOpen:o,onUpload:n,onAbort:l,onBatchCancelled:C,onClose:I,onDisplayChanged:a,onPublicId:s,onQueuesEnd:E,onQueuesStart:T,onRetry:m,onShowCompleted:r,onSourceChanged:c,onSuccess:f,onTags:P,onUploadAdded:w,options:_,signatureEndpoint:h,uploadPreset:O},({open:A,isLoading:u})=>{function M(N){N.preventDefault(),A(),typeof d=="function"&&d(N)}return R.createElement("button",{...W,className:e||"",onClick:M,disabled:u},t||"Upload")})),ae=De;import b,{useRef as q,useEffect as Se}from"react";import Ve from"next/script";import ke from"next/head";import{getVideoPlayerOptions as Ge}from"@cloudinary-util/url-loader";var j=[],le="1.11.1",Re=e=>{let{className:t,config:d,height:i,id:o,onDataLoad:n,onError:l,onMetadataLoad:C,onPause:I,onPlay:a,onEnded:s,width:E}=e,T=x(d),m=Ge(e,T),{publicId:r}=m;if(typeof r>"u")throw new Error("Video Player requires a Public ID or Cloudinary URL - please specify a src prop");let c=q(),f=q(),P=e.videoRef||f,w=q(),_=e.playerRef||w,h=o||`player-${r.replace("/","-")}`,O="cld-video-player cld-fluid";t&&(O=`${O} ${t}`),j.filter(g=>g===h).length>1?console.warn(`Multiple instances of the same video detected on the
     page which may cause some features to not work.
    Try adding a unique id to each player.`):j.push(h);let A={error:l,loadeddata:n,loadedmetadata:C,pause:I,play:a,ended:s};function u(g){let D=A[g.type];typeof D=="function"&&D(N())}function M(){"cloudinary"in window&&(c.current=window.cloudinary,_.current=c.current.videoPlayer(P.current,m),Object.keys(A).forEach(g=>{typeof A[g]=="function"&&_.current?.on(g,u)}))}Se(()=>()=>{_.current?.videojs.cloudinary.dispose(),j=j.filter(g=>g!==h)},[]);function N(){return{player:_.current,video:P.current}}return b.createElement(b.Fragment,null,b.createElement(ke,null,b.createElement("link",{href:`https://unpkg.com/cloudinary-video-player@${le}/dist/cld-video-player.min.css`,rel:"stylesheet"})),b.createElement("div",{style:{width:"100%",aspectRatio:`${E} / ${i}`}},b.createElement("video",{ref:P,id:h,className:O,width:E,height:i}),b.createElement(Ve,{id:`cloudinary-videoplayer-${h}-${Math.floor(Math.random()*100)}`,src:`https://unpkg.com/cloudinary-video-player@${le}/dist/cld-video-player.min.js`,onLoad:M,onError:g=>console.error(`Failed to load Cloudinary Video Player: ${g.message}`)})))},se=Re;import{constructCloudinaryUrl as je}from"@cloudinary-util/url-loader";function $e(e,t,d){return je({options:{assetType:"video",format:"auto:video",...e},config:x(t),analytics:V(d)})}export{oe as CldImage,re as CldOgImage,ae as CldUploadButton,G as CldUploadWidget,se as CldVideoPlayer,B as cloudinaryLoader,v as getCldImageUrl,k as getCldOgImageUrl,$e as getCldVideoUrl};
//# sourceMappingURL=index.mjs.map